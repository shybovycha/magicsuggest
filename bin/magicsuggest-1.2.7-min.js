(function(b){var a=function(j,q){var d=this;var i={allowFreeEntries:true,cls:"",data:null,dataUrlParams:{},disabled:false,displayField:"name",editable:true,emptyText:function(){return k.editable?"Type or click here":"Click here"},emptyTextCls:"ms-empty-text",expanded:false,expandOnFocus:function(){return k.editable?false:true},groupBy:null,hideTrigger:false,highlight:true,id:function(){return"ms-ctn-"+b('div[id^="ms-ctn"]').length},infoMsgCls:"",inputCfg:{},invalidCls:"ms-ctn-invalid",matchCase:false,maxDropHeight:290,maxEntryLength:null,maxEntryRenderer:function(r){return"Please reduce your entry by "+r+" character"+(r>1?"s":"")},maxSuggestions:null,maxSelection:10,maxSelectionRenderer:function(r){return"You cannot choose more than "+r+" item"+(r>1?"s":"")},method:"POST",minChars:0,minInputWidth:200,minCharsRenderer:function(r){return"Please type "+r+" more character"+(r>1?"s":"")},name:null,noSuggestionText:"No suggestions",preselectSingleSuggestion:true,renderer:null,required:false,resultAsString:false,returnJSON:false,selectionCls:"",selectionPosition:"inner",selectionRenderer:null,selectionStacked:false,sortDir:"asc",sortOrder:null,strictSuggest:false,style:"",toggleOnClick:false,typeDelay:400,useTabKey:false,useCommaKey:true,useSpaceKey:false,useSemicolonKey:false,useZebraStyle:true,value:null,valueField:"id",width:function(){return b(this).width()}};var l=b.extend({},q);var k=b.extend(true,{},i,l);if(b.isFunction(k.emptyText)){k.emptyText=k.emptyText.call(this)}if(b.isFunction(k.expandOnFocus)){k.expandOnFocus=k.expandOnFocus.call(this)}if(b.isFunction(k.id)){k.id=k.id.call(this)}this.addToSelection=function(r,u){if(!k.maxSelection||n.length<k.maxSelection){if(!b.isArray(r)){r=[r]}var t=false,s=this;b.each(r,function(v,x){if(b.inArray(x[k.valueField],d.getValue())===-1){for(var w in x){if(x.hasOwnProperty(w)){x[w]=x[w].trim()}}var y=b.Event("beforeitemadded",{tag_data:x.name});b(s.container).trigger(y);if(y.isDefaultPrevented()){if(y.message){o._updateHelper(y.message);d.helper.addClass("ms-error-message")}return}n.push(x);t=true}});if(t===true){o._renderSelection();this.empty();if(u!==true){b(this).trigger("selectionchange",[this,this.getSelectedItems()])}}}};this.clear=function(r){this.removeFromSelection(n.slice(0))};this.collapse=function(){if(k.expanded===true){this.combobox.detach();k.expanded=false;b(this).trigger("collapse",[this])}};this.disable=function(){this.container.addClass("ms-ctn-disabled");k.disabled=true};this.empty=function(){this.input.removeClass(k.emptyTextCls);this.input.val("")};this.enable=function(){this.container.removeClass("ms-ctn-disabled");k.disabled=false};this.expand=function(){if(!k.expanded&&(this.input.val().length>=k.minChars||this.combobox.children().size()>0)){this.combobox.appendTo(this.container);o._processSuggestions();k.expanded=true;b(this).trigger("expand",[this])}};this.isDisabled=function(){return k.disabled};this.isValid=function(){return k.required===false||n.length>0};this.getDataUrlParams=function(){return k.dataUrlParams};this.getSelectedItems=function(){return n};this.getRawValue=function(){return d.input.val()!==k.emptyText?d.input.val():""};this.getValue=function(){return b.map(n,function(r){return r[k.valueField]})};this.removeFromSelection=function(r,t){if(!b.isArray(r)){r=[r]}var s=false;b.each(r,function(u,w){var v=b.inArray(w[k.valueField],d.getValue());if(v>-1){n.splice(v,1);s=true}});if(s===true){o._renderSelection();if(t!==true){b(this).trigger("selectionchange",[this,this.getSelectedItems()])}if(k.expandOnFocus){d.expand()}if(k.expanded){o._processSuggestions()}}};this.setData=function(r){k.data=r;o._processSuggestions()};this.setValue=function(t){var s=b.isArray(t)?t:[t],r=[];b.each(e,function(u,v){if(b.inArray(v[k.valueField],s)>-1){r.push(v)}});if(r.length>0){this.addToSelection(r)}};this.setDataUrlParams=function(r){k.dataUrlParams=b.extend({},r)};var n=[],c=0,h,f=false,m=null,e=[],p=false;var o={_displaySuggestions:function(t){d.combobox.empty();var u=0,r=0;if(m===null){o._renderComboItems(t);u=c*t.length}else{for(var s in m){r+=1;b("<div/>",{"class":"ms-res-group",html:s}).appendTo(d.combobox);o._renderComboItems(m[s].items,true)}u=c*(t.length+r)}if(u<d.combobox.height()||u<=k.maxDropHeight){d.combobox.height(u)}else{if(u>=d.combobox.height()&&u>k.maxDropHeight){d.combobox.height(k.maxDropHeight)}}if(t.length===1&&k.preselectSingleSuggestion===true){d.combobox.children().filter(":last").addClass("ms-res-item-active")}if(t.length===0&&d.getRawValue()!==""){o._updateHelper(k.noSuggestionText);d.collapse()}},_getEntriesFromStringArray:function(s){var r=[];b.each(s,function(t,u){var v={};v[k.displayField]=v[k.valueField]=b.trim(u);if(v[k.valueField].length>0){r.push(v)}});return r},_highlightSuggestion:function(r){var s=d.input.val()!==k.emptyText?d.input.val():"";if(s.length===0){return r}if(k.matchCase===true){r=r.replace(new RegExp("("+s+")(?!([^<]+)?>)","g"),"<em>$1</em>")}else{r=r.replace(new RegExp("("+s+")(?!([^<]+)?>)","gi"),"<em>$1</em>")}return r},_moveSelectedRow:function(r){if(!k.expanded){d.expand()}var s,v,t,u;s=d.combobox.find(".ms-res-item");if(r==="down"){v=s.eq(0)}else{v=s.filter(":last")}t=d.combobox.find(".ms-res-item-active:first");if(t.length>0){if(r==="down"){v=t.nextAll(".ms-res-item").first();if(v.length===0){v=s.eq(0)}u=d.combobox.scrollTop();d.combobox.scrollTop(0);if(v[0].offsetTop+v.outerHeight()>d.combobox.height()){d.combobox.scrollTop(u+c)}}else{v=t.prevAll(".ms-res-item").first();if(v.length===0){v=s.filter(":last");d.combobox.scrollTop(c*s.length)}if(v[0].offsetTop<d.combobox.scrollTop()){d.combobox.scrollTop(d.combobox.scrollTop()-c)}}}s.removeClass("ms-res-item-active");v.addClass("ms-res-item-active")},_processSuggestions:function(t){var r=null,s=t||k.data;if(s!==null){if(typeof(s)==="function"){s=s.call(d)}if(typeof(s)==="string"&&s.trim().length>0&&s.indexOf(",")<0){b(d).trigger("beforeload",[d]);var u=b.extend({query:d.input.val()},k.dataUrlParams);b.ajax({type:k.method,url:s,data:u,success:function(v){o._processSuggestions(v);b(d).trigger("load",[d,r])},error:function(){throw ("Could not reach server")}});return}else{if(typeof(s)==="string"&&s.indexOf(",")>-1){s=s.split(",").filter(function(v,w){return(typeof(w)==="string")&&(w.trim().length>0)});e=o._getEntriesFromStringArray(s)}else{if(s.length>0&&typeof(s[0])==="string"){e=o._getEntriesFromStringArray(s)}else{e=s.results||s}}}o._displaySuggestions(o._sortAndTrim(e))}},_render:function(s){b(d).trigger("beforerender",[d]);var r=b.isFunction(k.width)?k.width.call(s):k.width;d.container=b("<div/>",{id:k.id,"class":"ms-ctn "+k.cls+(k.disabled===true?" ms-ctn-disabled":"")+(k.editable===true?"":" ms-ctn-readonly"),style:"width: "+r+"px;"+k.style});d.container.focus(b.proxy(g._onFocus,this));d.container.blur(b.proxy(g._onBlur,this));d.container.keydown(b.proxy(g._onKeyDown,this));d.container.keyup(b.proxy(g._onKeyUp,this));d.input=b("<input/>",b.extend({id:"ms-input-"+b('input[id^="ms-input"]').length,type:"text","class":k.emptyTextCls+(k.editable===true?"":" ms-input-readonly"),value:k.emptyText,readonly:!k.editable,disabled:k.disabled,style:"width: "+(r-(k.hideTrigger?16:42))+"px;"},k.inputCfg));d.input.addClass("ms-input");d.input.focus(b.proxy(g._onInputFocus,this));d.input.click(b.proxy(g._onInputClick,this));if(k.hideTrigger===false){d.trigger=b("<div/>",{id:"ms-trigger-"+b('div[id^="ms-trigger"]').length,"class":"ms-trigger",html:'<div class="ms-trigger-ico"></div>'});d.trigger.click(b.proxy(g._onTriggerClick,this));d.container.append(d.trigger)}d.combobox=b("<div/>",{id:"ms-res-ctn-"+b('div[id^="ms-res-ctn"]').length,"class":"ms-res-ctn ",style:"width: "+r+"px; height: "+k.maxDropHeight+"px;"});d.combobox.on("click","div.ms-res-item",b.proxy(g._onComboItemSelected,this));d.combobox.on("mouseover","div.ms-res-item",b.proxy(g._onComboItemMouseOver,this));d.selectionContainer=b("<div/>",{id:"ms-sel-ctn-"+b('div[id^="ms-sel-ctn"]').length,"class":"ms-sel-ctn"});d.selectionContainer.click(b.proxy(g._onFocus,this));if(k.selectionPosition==="inner"){d.selectionContainer.append(d.input)}else{d.container.append(d.input)}d.helper=b("<div/>",{"class":"ms-helper "+k.infoMsgCls});o._updateHelper();d.container.append(d.helper);b(s).replaceWith(d.container);switch(k.selectionPosition){case"bottom":d.selectionContainer.insertAfter(d.container);if(k.selectionStacked===true){d.selectionContainer.width(d.container.width());d.selectionContainer.addClass("ms-stacked")}break;case"right":d.selectionContainer.insertAfter(d.container);d.container.css("float","left");break;default:d.container.append(d.selectionContainer);break}o._processSuggestions();if(k.value!==null){d.setValue(k.value);o._renderSelection()}b(d).trigger("afterrender",[d]);b("body").click(function(t){if(d.container.hasClass("ms-ctn-bootstrap-focus")&&d.container.has(t.target).length===0&&t.target.className.indexOf("ms-res-item")<0&&t.target.className.indexOf("ms-close-btn")<0&&d.container[0]!==t.target){g._onBlur()}});if(k.expanded===true){k.expanded=false;d.expand()}},_renderComboItems:function(r,u){var t=this,s="";b.each(r,function(v,x){var w=k.renderer!==null?k.renderer.call(t,x):x[k.displayField];var y=b("<div/>",{"class":"ms-res-item "+(u?"ms-res-item-grouped ":"")+(v%2===1&&k.useZebraStyle===true?"ms-res-odd":""),html:k.highlight===true?o._highlightSuggestion(w):w,"data-json":JSON.stringify(x)});y.click(b.proxy(g._onComboItemSelected,t));y.mouseover(b.proxy(g._onComboItemMouseOver,t));s+=b("<div/>").append(y).html()});d.combobox.html(s);c=Math.max.apply(Math,d.combobox.find(".ms-res-item").map(function(v,w){return b(w).outerHeight()}).toArray())},_renderSelection:function(){var u=this,r=0,t=0,s=[],v=k.resultAsString===true&&!f;d.selectionContainer.find(".ms-sel-item").remove();if(d._valueContainer!==undefined){d._valueContainer.remove()}b.each(n,function(z,B){var A,y,w=k.selectionRenderer!==null?k.selectionRenderer.call(u,B):B[k.displayField];if(v===true){A=b("<div/>",{"class":"ms-sel-item ms-sel-text "+k.selectionCls,html:w+(z===(n.length-1)?"":",")}).data("json",B)}else{A=b("<div/>",{"class":"ms-sel-item "+k.selectionCls,html:w}).data("json",B);if(k.disabled===false){y=b("<span/>",{"class":"ms-close-btn"}).data("json",B).appendTo(A);y.click(b.proxy(g._onTagTriggerClick,u))}}s.push(A)});var x=(k.returnJSON)?JSON.stringify(d.getValue()):d.getValue().join(",");d.selectionContainer.prepend(s);d._valueContainer=b("<input/>",{type:"hidden",name:k.name,value:x});d._valueContainer.appendTo(d.selectionContainer);if(k.selectionPosition==="inner"){d.input.width(0);t=d.input.offset().left-d.selectionContainer.offset().left;r=Math.max(k.minInputWidth,d.container.width()-t-(k.hideTrigger===true?0:42));d.input.width(r);if(d.selectionContainer.height()>0){d.container.height(d.selectionContainer.height())}}if(n.length===k.maxSelection){o._updateHelper(k.maxSelectionRenderer.call(this,n.length))}else{d.helper.hide()}},_selectItem:function(r){if(k.maxSelection===1){n=[]}d.addToSelection(r.data("json"));r.removeClass("ms-res-item-active");if(k.expandOnFocus===false||n.length===k.maxSelection){d.collapse()}if(!f){d.input.focus()}else{if(f&&(k.expandOnFocus||p)){o._processSuggestions();if(p){d.expand()}}}},_sortAndTrim:function(u){var t=d.getRawValue(),s=[],v=[],r=d.getValue();if(t.length>0){b.each(u,function(x,y){var w=y[k.displayField];if((k.matchCase===true&&w.indexOf(t)>-1)||(k.matchCase===false&&w.toLowerCase().indexOf(t.toLowerCase())>-1)){if(k.strictSuggest===false||w.toLowerCase().indexOf(t.toLowerCase())===0){s.push(y)}}})}else{s=u}b.each(s,function(w,x){if(b.inArray(x[k.valueField],r)===-1){v.push(x)}});if(k.sortOrder!==null){v.sort(function(x,w){if(x[k.sortOrder]<w[k.sortOrder]){return k.sortDir==="asc"?-1:1}if(x[k.sortOrder]>w[k.sortOrder]){return k.sortDir==="asc"?1:-1}return 0})}if(k.maxSuggestions&&k.maxSuggestions>0){v=v.slice(0,k.maxSuggestions)}if(k.groupBy!==null){m={};b.each(v,function(w,x){if(m[x[k.groupBy]]===undefined){m[x[k.groupBy]]={title:x[k.groupBy],items:[x]}}else{m[x[k.groupBy]].items.push(x)}})}return v},_updateHelper:function(r){d.helper.removeClass("ms-error-message");d.helper.html(r);if(!d.helper.is(":visible")){d.helper.fadeIn()}}};var g={_onBlur:function(){d.container.removeClass("ms-ctn-bootstrap-focus");d.collapse();f=false;if(d.getRawValue()!==""&&k.allowFreeEntries===true){var r={};r[k.displayField]=r[k.valueField]=d.getRawValue();d.addToSelection(r)}o._renderSelection();if(d.isValid()===false){d.container.addClass("ms-ctn-invalid")}if(d.input.val()===""&&n.length===0){d.input.addClass(k.emptyTextCls);d.input.val(k.emptyText)}else{if(d.input.val()!==""&&k.allowFreeEntries===false){d.empty();o._updateHelper("")}}if(d.input.is(":focus")){b(d).trigger("blur",[d])}},_onComboItemMouseOver:function(r){d.combobox.children().removeClass("ms-res-item-active");b(r.currentTarget).addClass("ms-res-item-active")},_onComboItemSelected:function(r){o._selectItem(b(r.currentTarget))},_onFocus:function(){d.input.focus()},_onInputClick:function(){if(d.isDisabled()===false&&f){if(k.toggleOnClick===true){if(k.expanded){d.collapse()}else{d.expand()}}}},_onInputFocus:function(){if(d.isDisabled()===false&&!f){f=true;d.container.addClass("ms-ctn-bootstrap-focus");d.container.removeClass(k.invalidCls);if(d.input.val()===k.emptyText){d.empty()}var r=d.getRawValue().length;if(k.expandOnFocus===true){d.expand()}if(n.length===k.maxSelection){o._updateHelper(k.maxSelectionRenderer.call(this,n.length))}else{if(r<k.minChars){o._updateHelper(k.minCharsRenderer.call(this,k.minChars-r))}}o._renderSelection();b(d).trigger("focus",[d])}},_onKeyDown:function(t){var s=d.combobox.find(".ms-res-item-active:first"),r=d.input.val()!==k.emptyText?d.input.val():"";b(d).trigger("keydown",[d,t]);if(t.keyCode===9&&(k.useTabKey===false||(k.useTabKey===true&&s.length===0&&d.input.val().length===0))){g._onBlur();return}switch(t.keyCode){case 8:if(r.length===0&&d.getSelectedItems().length>0&&k.selectionPosition==="inner"){n.pop();o._renderSelection();b(d).trigger("selectionchange",[d,d.getSelectedItems()]);d.input.focus();t.preventDefault()}break;case 9:case 188:case 186:case 13:t.preventDefault();break;case 17:p=true;break;case 40:t.preventDefault();o._moveSelectedRow("down");break;case 38:t.preventDefault();o._moveSelectedRow("up");break;default:if(n.length===k.maxSelection){t.preventDefault()}break}},_onKeyUp:function(u){var r=d.getRawValue(),v=b.trim(d.input.val()).length>0&&d.input.val()!==k.emptyText&&(!k.maxEntryLength||b.trim(d.input.val()).length<=k.maxEntryLength),s,t={};b(d).trigger("keyup",[d,u]);clearTimeout(h);if(u.keyCode===27&&k.expanded){d.combobox.height(0)}if((u.keyCode===9&&k.useTabKey===false)||(u.keyCode>13&&u.keyCode<32)){if(u.keyCode===17){p=false}return}switch(u.keyCode){case 40:case 38:u.preventDefault();break;case 13:case 9:case 188:case 186:case 32:if((u.keyCode!==186&&u.keyCode!==188&&u.keyCode!==32)||k.useCommaKey===true||k.useSemicolonKey===true||k.useSpaceKey===true){u.preventDefault();if(k.expanded===true){s=d.combobox.find(".ms-res-item-active:first");if(s.length>0){o._selectItem(s);return}}if(v===true&&k.allowFreeEntries===true){t[k.displayField]=t[k.valueField]=r;d.addToSelection(t);d.collapse();d.input.focus()}break}default:if(n.length===k.maxSelection){o._updateHelper(k.maxSelectionRenderer.call(this,n.length))}else{if(r.length<k.minChars){o._updateHelper(k.minCharsRenderer.call(this,k.minChars-r.length));if(k.expanded===true){d.collapse()}}else{if(k.maxEntryLength&&r.length>k.maxEntryLength){o._updateHelper(k.maxEntryRenderer.call(this,r.length-k.maxEntryLength));if(k.expanded===true){d.collapse()}}else{d.helper.hide();if(k.minChars<=r.length){h=setTimeout(function(){if(k.expanded===true){o._processSuggestions()}else{d.expand()}},k.typeDelay)}}}}break}},_onTagTriggerClick:function(r){d.removeFromSelection(b(r.currentTarget).data("json"))},_onTriggerClick:function(){if(d.isDisabled()===false&&!(k.expandOnFocus===true&&n.length===k.maxSelection)){b(d).trigger("triggerclick",[d]);if(k.expanded===true){d.collapse()}else{var r=d.getRawValue().length;if(r>=k.minChars){d.input.focus();d.expand()}else{o._updateHelper(k.minCharsRenderer.call(this,k.minChars-r))}}}}};if(j!==null){o._render(j)}};b.fn.magicSuggest=function(c){var d=b(this);if(d.size()===1&&d.data("magicSuggest")){return d.data("magicSuggest")}d.each(function(e){var g=b(this);if(g.data("magicSuggest")){return}if(this.nodeName.toLowerCase()==="select"){c.data=[];c.value=[];b.each(this.children,function(i,j){if(j.nodeName&&j.nodeName.toLowerCase()==="option"){c.data.push({id:j.value,name:j.text});if(j.selected){c.value.push(j.value)}}})}var f={};b.each(this.attributes,function(k,j){f[j.name]=j.value});var h=new a(this,b.extend(c,f));g.data("magicSuggest",h)});if(d.size()===1){return d.data("magicSuggest")}return d}})(jQuery);
