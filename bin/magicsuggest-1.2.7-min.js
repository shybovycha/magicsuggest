(function(e){"use strict";var t=function(t,n){var r=this;var i={allowFreeEntries:true,cls:"",data:null,dataUrlParams:{},disabled:false,displayField:"name",editable:true,emptyText:function(){return o.editable?"Type or click here":"Click here"},emptyTextCls:"ms-empty-text",expanded:false,expandOnFocus:function(){return o.editable?false:true},groupBy:null,hideTrigger:false,highlight:true,id:function(){return"ms-ctn-"+e('div[id^="ms-ctn"]').length},infoMsgCls:"",inputCfg:{},invalidCls:"ms-ctn-invalid",matchCase:false,maxDropHeight:290,maxEntryLength:null,maxEntryRenderer:function(e){return"Please reduce your entry by "+e+" character"+(e>1?"s":"")},maxSuggestions:null,maxSelection:10,maxSelectionRenderer:function(e){return"You cannot choose more than "+e+" item"+(e>1?"s":"")},method:"POST",minChars:0,minInputWidth:200,minCharsRenderer:function(e){return"Please type "+e+" more character"+(e>1?"s":"")},name:null,noSuggestionText:"No suggestions",preselectSingleSuggestion:true,renderer:null,required:false,resultAsString:false,selectionCls:"",selectionPosition:"inner",selectionRenderer:null,selectionStacked:false,sortDir:"asc",sortOrder:null,strictSuggest:false,style:"",toggleOnClick:false,typeDelay:400,useTabKey:false,useCommaKey:true,useSpaceKey:false,useZebraStyle:true,value:null,valueField:"id",width:function(){return e(this).width()}};var s=e.extend({},n);var o=e.extend(true,{},i,s);if(e.isFunction(o.emptyText)){o.emptyText=o.emptyText.call(this)}if(e.isFunction(o.expandOnFocus)){o.expandOnFocus=o.expandOnFocus.call(this)}if(e.isFunction(o.id)){o.id=o.id.call(this)}this.addToSelection=function(t,n){if(!o.maxSelection||u.length<o.maxSelection){if(!e.isArray(t)){t=[t]}var i=false,s=this;e.each(t,function(t,n){if(e.inArray(n[o.valueField],r.getValue())===-1){var a=e.Event("beforeitemadded",{email:n["name"].trim()});e(s.container).trigger(a);if(a.isDefaultPrevented()){if(a["message"]){d._updateHelper(a["message"]);r.helper.addClass("ms-error-message")}return}u.push(n);i=true}});if(i===true){d._renderSelection();this.empty();if(n!==true){e(this).trigger("selectionchange",[this,this.getSelectedItems()])}}}};this.clear=function(e){this.removeFromSelection(u.slice(0))};this.collapse=function(){if(o.expanded===true){this.combobox.detach();o.expanded=false;e(this).trigger("collapse",[this])}};this.disable=function(){this.container.addClass("ms-ctn-disabled");o.disabled=true};this.empty=function(){this.input.removeClass(o.emptyTextCls);this.input.val("")};this.enable=function(){this.container.removeClass("ms-ctn-disabled");o.disabled=false};this.expand=function(){if(!o.expanded&&(this.input.val().length>=o.minChars||this.combobox.children().size()>0)){this.combobox.appendTo(this.container);d._processSuggestions();o.expanded=true;e(this).trigger("expand",[this])}};this.isDisabled=function(){return o.disabled};this.isValid=function(){return o.required===false||u.length>0};this.getDataUrlParams=function(){return o.dataUrlParams};this.getSelectedItems=function(){return u};this.getRawValue=function(){return r.input.val()!==o.emptyText?r.input.val():""};this.getValue=function(){return e.map(u,function(e){return e[o.valueField]})};this.removeFromSelection=function(t,n){if(!e.isArray(t)){t=[t]}var i=false;e.each(t,function(t,n){var s=e.inArray(n[o.valueField],r.getValue());if(s>-1){u.splice(s,1);i=true}});if(i===true){d._renderSelection();if(n!==true){e(this).trigger("selectionchange",[this,this.getSelectedItems()])}if(o.expandOnFocus){r.expand()}if(o.expanded){d._processSuggestions()}}};this.setData=function(e){o.data=e;d._processSuggestions()};this.setValue=function(t){var n=e.isArray(t)?t:[t],r=[];e.each(h,function(t,i){if(e.inArray(i[o.valueField],n)>-1){r.push(i)}});if(r.length>0){this.addToSelection(r)}};this.setDataUrlParams=function(t){o.dataUrlParams=e.extend({},t)};var u=[],a=0,f,l=false,c=null,h=[],p=false;var d={_displaySuggestions:function(t){r.combobox.empty();var n=0,i=0;if(c===null){d._renderComboItems(t);n=a*t.length}else{for(var s in c){i+=1;e("<div/>",{"class":"ms-res-group",html:s}).appendTo(r.combobox);d._renderComboItems(c[s].items,true)}n=a*(t.length+i)}if(n<r.combobox.height()||n<=o.maxDropHeight){r.combobox.height(n)}else if(n>=r.combobox.height()&&n>o.maxDropHeight){r.combobox.height(o.maxDropHeight)}if(t.length===1&&o.preselectSingleSuggestion===true){r.combobox.children().filter(":last").addClass("ms-res-item-active")}if(t.length===0&&r.getRawValue()!==""){d._updateHelper(o.noSuggestionText);r.collapse()}},_getEntriesFromStringArray:function(t){var n=[];e.each(t,function(t,r){var i={};i[o.displayField]=i[o.valueField]=e.trim(r);n.push(i)});return n},_highlightSuggestion:function(e){var t=r.input.val()!==o.emptyText?r.input.val():"";if(t.length===0){return e}if(o.matchCase===true){e=e.replace(new RegExp("("+t+")(?!([^<]+)?>)","g"),"<em>$1</em>")}else{e=e.replace(new RegExp("("+t+")(?!([^<]+)?>)","gi"),"<em>$1</em>")}return e},_moveSelectedRow:function(e){if(!o.expanded){r.expand()}var t,n,i,s;t=r.combobox.find(".ms-res-item");if(e==="down"){n=t.eq(0)}else{n=t.filter(":last")}i=r.combobox.find(".ms-res-item-active:first");if(i.length>0){if(e==="down"){n=i.nextAll(".ms-res-item").first();if(n.length===0){n=t.eq(0)}s=r.combobox.scrollTop();r.combobox.scrollTop(0);if(n[0].offsetTop+n.outerHeight()>r.combobox.height()){r.combobox.scrollTop(s+a)}}else{n=i.prevAll(".ms-res-item").first();if(n.length===0){n=t.filter(":last");r.combobox.scrollTop(a*t.length)}if(n[0].offsetTop<r.combobox.scrollTop()){r.combobox.scrollTop(r.combobox.scrollTop()-a)}}}t.removeClass("ms-res-item-active");n.addClass("ms-res-item-active")},_processSuggestions:function(t){var n=null,i=t||o.data;if(i!==null){if(typeof i==="function"){i=i.call(r)}if(typeof i==="string"&&o.data.trim().length>0&&i.indexOf(",")<0){e(r).trigger("beforeload",[r]);var s=e.extend({query:r.input.val()},o.dataUrlParams);e.ajax({type:o.method,url:i,data:s,success:function(t){d._processSuggestions(t);e(r).trigger("load",[r,n])},error:function(){throw"Could not reach server"}});return}else if(typeof i==="string"&&i.indexOf(",")>-1){h=d._getEntriesFromStringArray(i.split(","))}else{if(i.length>0&&typeof i[0]==="string"){h=d._getEntriesFromStringArray(i)}else{h=i.results||i}}d._displaySuggestions(d._sortAndTrim(h))}},_render:function(t){e(r).trigger("beforerender",[r]);var n=e.isFunction(o.width)?o.width.call(t):o.width;r.container=e("<div/>",{id:o.id,"class":"ms-ctn "+o.cls+(o.disabled===true?" ms-ctn-disabled":"")+(o.editable===true?"":" ms-ctn-readonly"),style:"width: "+n+"px;"+o.style});r.container.focus(e.proxy(v._onFocus,this));r.container.blur(e.proxy(v._onBlur,this));r.container.keydown(e.proxy(v._onKeyDown,this));r.container.keyup(e.proxy(v._onKeyUp,this));r.input=e("<input/>",e.extend({id:"ms-input-"+e('input[id^="ms-input"]').length,type:"text","class":o.emptyTextCls+(o.editable===true?"":" ms-input-readonly"),value:o.emptyText,readonly:!o.editable,disabled:o.disabled,style:"width: "+(n-(o.hideTrigger?16:42))+"px;"},o.inputCfg));r.input.addClass("ms-input");r.input.focus(e.proxy(v._onInputFocus,this));r.input.click(e.proxy(v._onInputClick,this));if(o.hideTrigger===false){r.trigger=e("<div/>",{id:"ms-trigger-"+e('div[id^="ms-trigger"]').length,"class":"ms-trigger",html:'<div class="ms-trigger-ico"></div>'});r.trigger.click(e.proxy(v._onTriggerClick,this));r.container.append(r.trigger)}r.combobox=e("<div/>",{id:"ms-res-ctn-"+e('div[id^="ms-res-ctn"]').length,"class":"ms-res-ctn ",style:"width: "+n+"px; height: "+o.maxDropHeight+"px;"});r.combobox.on("click","div.ms-res-item",e.proxy(v._onComboItemSelected,this));r.combobox.on("mouseover","div.ms-res-item",e.proxy(v._onComboItemMouseOver,this));r.selectionContainer=e("<div/>",{id:"ms-sel-ctn-"+e('div[id^="ms-sel-ctn"]').length,"class":"ms-sel-ctn"});r.selectionContainer.click(e.proxy(v._onFocus,this));if(o.selectionPosition==="inner"){r.selectionContainer.append(r.input)}else{r.container.append(r.input)}r.helper=e("<div/>",{"class":"ms-helper "+o.infoMsgCls});d._updateHelper();r.container.append(r.helper);e(t).replaceWith(r.container);switch(o.selectionPosition){case"bottom":r.selectionContainer.insertAfter(r.container);if(o.selectionStacked===true){r.selectionContainer.width(r.container.width());r.selectionContainer.addClass("ms-stacked")}break;case"right":r.selectionContainer.insertAfter(r.container);r.container.css("float","left");break;default:r.container.append(r.selectionContainer);break}d._processSuggestions();if(o.value!==null){r.setValue(o.value);d._renderSelection()}e(r).trigger("afterrender",[r]);e("body").click(function(e){if(r.container.hasClass("ms-ctn-bootstrap-focus")&&r.container.has(e.target).length===0&&e.target.className.indexOf("ms-res-item")<0&&e.target.className.indexOf("ms-close-btn")<0&&r.container[0]!==e.target){v._onBlur()}});if(o.expanded===true){o.expanded=false;r.expand()}},_renderComboItems:function(t,n){var i=this,s="";e.each(t,function(t,r){var u=o.renderer!==null?o.renderer.call(i,r):r[o.displayField];var a=e("<div/>",{"class":"ms-res-item "+(n?"ms-res-item-grouped ":"")+(t%2===1&&o.useZebraStyle===true?"ms-res-odd":""),html:o.highlight===true?d._highlightSuggestion(u):u,"data-json":JSON.stringify(r)});a.click(e.proxy(v._onComboItemSelected,i));a.mouseover(e.proxy(v._onComboItemMouseOver,i));s+=e("<div/>").append(a).html()});r.combobox.html(s);a=r.combobox.find(".ms-res-item:first").outerHeight()},_renderSelection:function(){var t=this,n=0,i=0,s=[],a=o.resultAsString===true&&!l;r.selectionContainer.find(".ms-sel-item").remove();if(r._valueContainer!==undefined){r._valueContainer.remove()}e.each(u,function(n,r){var i,f,l=o.selectionRenderer!==null?o.selectionRenderer.call(t,r):r[o.displayField];if(a===true){i=e("<div/>",{"class":"ms-sel-item ms-sel-text "+o.selectionCls,html:l+(n===u.length-1?"":",")}).data("json",r)}else{i=e("<div/>",{"class":"ms-sel-item "+o.selectionCls,html:l}).data("json",r);if(o.disabled===false){f=e("<span/>",{"class":"ms-close-btn"}).data("json",r).appendTo(i);f.click(e.proxy(v._onTagTriggerClick,t))}}s.push(i)});r.selectionContainer.prepend(s);r._valueContainer=e("<input/>",{type:"hidden",name:o.name,value:JSON.stringify(r.getValue())});r._valueContainer.appendTo(r.selectionContainer);if(o.selectionPosition==="inner"){r.input.width(0);i=r.input.offset().left-r.selectionContainer.offset().left;n=Math.max(o.minInputWidth,r.container.width()-i-(o.hideTrigger===true?0:42));r.input.width(n);if(r.selectionContainer.height()>0)r.container.height(r.selectionContainer.height())}if(u.length===o.maxSelection){d._updateHelper(o.maxSelectionRenderer.call(this,u.length))}else{r.helper.hide()}},_selectItem:function(e){if(o.maxSelection===1){u=[]}r.addToSelection(e.data("json"));e.removeClass("ms-res-item-active");if(o.expandOnFocus===false||u.length===o.maxSelection){r.collapse()}if(!l){r.input.focus()}else if(l&&(o.expandOnFocus||p)){d._processSuggestions();if(p){r.expand()}}},_sortAndTrim:function(t){var n=r.getRawValue(),i=[],s=[],u=r.getValue();if(n.length>0){e.each(t,function(e,t){var r=t[o.displayField];if(o.matchCase===true&&r.indexOf(n)>-1||o.matchCase===false&&r.toLowerCase().indexOf(n.toLowerCase())>-1){if(o.strictSuggest===false||r.toLowerCase().indexOf(n.toLowerCase())===0){i.push(t)}}})}else{i=t}e.each(i,function(t,n){if(e.inArray(n[o.valueField],u)===-1){s.push(n)}});if(o.sortOrder!==null){s.sort(function(e,t){if(e[o.sortOrder]<t[o.sortOrder]){return o.sortDir==="asc"?-1:1}if(e[o.sortOrder]>t[o.sortOrder]){return o.sortDir==="asc"?1:-1}return 0})}if(o.maxSuggestions&&o.maxSuggestions>0){s=s.slice(0,o.maxSuggestions)}if(o.groupBy!==null){c={};e.each(s,function(e,t){if(c[t[o.groupBy]]===undefined){c[t[o.groupBy]]={title:t[o.groupBy],items:[t]}}else{c[t[o.groupBy]].items.push(t)}})}return s},_updateHelper:function(e){r.helper.removeClass("ms-error-message");r.helper.html(e);if(!r.helper.is(":visible")){r.helper.fadeIn()}}};var v={_onBlur:function(){r.container.removeClass("ms-ctn-bootstrap-focus");r.collapse();l=false;if(r.getRawValue()!==""&&o.allowFreeEntries===true){var t={};t[o.displayField]=t[o.valueField]=r.getRawValue();r.addToSelection(t)}d._renderSelection();if(r.isValid()===false){r.container.addClass("ms-ctn-invalid")}if(r.input.val()===""&&u.length===0){r.input.addClass(o.emptyTextCls);r.input.val(o.emptyText)}else if(r.input.val()!==""&&o.allowFreeEntries===false){r.empty();d._updateHelper("")}if(r.input.is(":focus")){e(r).trigger("blur",[r])}},_onComboItemMouseOver:function(t){r.combobox.children().removeClass("ms-res-item-active");e(t.currentTarget).addClass("ms-res-item-active")},_onComboItemSelected:function(t){d._selectItem(e(t.currentTarget))},_onFocus:function(){r.input.focus()},_onInputClick:function(){if(r.isDisabled()===false&&l){if(o.toggleOnClick===true){if(o.expanded){r.collapse()}else{r.expand()}}}},_onInputFocus:function(){if(r.isDisabled()===false&&!l){l=true;r.container.addClass("ms-ctn-bootstrap-focus");r.container.removeClass(o.invalidCls);if(r.input.val()===o.emptyText){r.empty()}var t=r.getRawValue().length;if(o.expandOnFocus===true){r.expand()}if(u.length===o.maxSelection){d._updateHelper(o.maxSelectionRenderer.call(this,u.length))}else if(t<o.minChars){d._updateHelper(o.minCharsRenderer.call(this,o.minChars-t))}d._renderSelection();e(r).trigger("focus",[r])}},_onKeyDown:function(t){var n=r.combobox.find(".ms-res-item-active:first"),i=r.input.val()!==o.emptyText?r.input.val():"";e(r).trigger("keydown",[r,t]);if(t.keyCode===9&&(o.useTabKey===false||o.useTabKey===true&&n.length===0&&r.input.val().length===0)){v._onBlur();return}switch(t.keyCode){case 8:if(i.length===0&&r.getSelectedItems().length>0&&o.selectionPosition==="inner"){u.pop();d._renderSelection();e(r).trigger("selectionchange",[r,r.getSelectedItems()]);r.input.focus();t.preventDefault()}break;case 9:case 188:case 13:t.preventDefault();break;case 17:p=true;break;case 40:t.preventDefault();d._moveSelectedRow("down");break;case 38:t.preventDefault();d._moveSelectedRow("up");break;default:if(u.length===o.maxSelection){t.preventDefault()}break}},_onKeyUp:function(t){var n=r.getRawValue(),i=e.trim(r.input.val()).length>0&&r.input.val()!==o.emptyText&&(!o.maxEntryLength||e.trim(r.input.val()).length<=o.maxEntryLength),s,a={};e(r).trigger("keyup",[r,t]);clearTimeout(f);if(t.keyCode===27&&o.expanded){r.combobox.height(0)}if(t.keyCode===9&&o.useTabKey===false||t.keyCode>13&&t.keyCode<32){if(t.keyCode===17){p=false}return}switch(t.keyCode){case 40:case 38:t.preventDefault();break;case 13:case 9:case 188:case 32:if(t.keyCode!==188&&t.keyCode!==32||o.useCommaKey===true||o.useSpaceKey===true){t.preventDefault();if(o.expanded===true){s=r.combobox.find(".ms-res-item-active:first");if(s.length>0){d._selectItem(s);return}}if(i===true&&o.allowFreeEntries===true){a[o.displayField]=a[o.valueField]=n;r.addToSelection(a);r.collapse();r.input.focus()}break};default:if(u.length===o.maxSelection){d._updateHelper(o.maxSelectionRenderer.call(this,u.length))}else{if(n.length<o.minChars){d._updateHelper(o.minCharsRenderer.call(this,o.minChars-n.length));if(o.expanded===true){r.collapse()}}else if(o.maxEntryLength&&n.length>o.maxEntryLength){d._updateHelper(o.maxEntryRenderer.call(this,n.length-o.maxEntryLength));if(o.expanded===true){r.collapse()}}else{r.helper.hide();if(o.minChars<=n.length){f=setTimeout(function(){if(o.expanded===true){d._processSuggestions()}else{r.expand()}},o.typeDelay)}}}break}},_onTagTriggerClick:function(t){r.removeFromSelection(e(t.currentTarget).data("json"))},_onTriggerClick:function(){if(r.isDisabled()===false&&!(o.expandOnFocus===true&&u.length===o.maxSelection)){e(r).trigger("triggerclick",[r]);if(o.expanded===true){r.collapse()}else{var t=r.getRawValue().length;if(t>=o.minChars){r.input.focus();r.expand()}else{d._updateHelper(o.minCharsRenderer.call(this,o.minChars-t))}}}}};if(t!==null){d._render(t)}};e.fn.magicSuggest=function(n){var r=e(this);if(r.size()===1&&r.data("magicSuggest")){return r.data("magicSuggest")}r.each(function(r){var i=e(this);if(i.data("magicSuggest")){return}if(this.nodeName.toLowerCase()==="select"){n.data=[];n.value=[];e.each(this.children,function(e,t){if(t.nodeName&&t.nodeName.toLowerCase()==="option"){n.data.push({id:t.value,name:t.text});if(t.selected){n.value.push(t.value)}}})}var s={};e.each(this.attributes,function(e,t){s[t.name]=t.value});var o=new t(this,e.extend(n,s));i.data("magicSuggest",o)});if(r.size()===1){return r.data("magicSuggest")}return r}})(jQuery)